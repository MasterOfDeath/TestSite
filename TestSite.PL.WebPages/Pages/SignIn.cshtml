<!DOCTYPE html>

@using TestSite.PL.WebPages.Models
@{
    Layout = null;

    string userIdStr = null;
    string password = null;
    string remember = null;
    string successMessage = null;
    string errorMessage = null;

    ICollection<TestSite.Entites.Dep> deps = null;

    var log = TestSite.Logger.Logger.Log;

    try
    {
        deps = LogicProvider.DepLogic.ListAllDeps();
    }
    catch (Exception ex)
    {
        errorMessage = ex.Message;
        log.Error(ex.Message);
    }

    if (!IsPost)
    {
        
    }

    if (IsPost)
    {   
        userIdStr = Request["employee-selector"];
        password = Request["password"];
        remember = Request["remember"];

        if (!string.IsNullOrEmpty(userIdStr) && !string.IsNullOrEmpty(password))
        {
            TestSite.Entites.Employee employee;

            try
            {
                int userId = Convert.ToInt32(userIdStr);
                employee = LogicProvider.EmployeeLogic.CanLogin(userId, password);
            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
                goto End;
            }

            if (employee != null)
            {
                log.Info(userIdStr + " has been loged");
                FormsAuthentication.SetAuthCookie(userIdStr, createPersistentCookie: (remember == "1"));
                Response.Cookies["usernamecookie"].Value = 
                   Server.UrlEncode(employee.LastName + " " + employee.FirstName);
                Response.Cookies["usernamecookie"].Expires = DateTime.Now.AddDays(1);
                Response.Redirect(Request["ReturnUrl"] ?? "/");
                return;
            }
            else
            {
                errorMessage = "Wrong name or password";
                log.Info("An unsuccessful attempt to login with userId: " + userIdStr);
            }
        }
    }

End:
}

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="~/Content/bootstrap.min.css" />
    <link rel="stylesheet" href="~/Content/ProjectStyles/style.css" />
    <link rel="stylesheet" href="~/Content/ProjectStyles/login.css" />
    <title>Вход</title>
</head>
<body>
    <div class="container content-login">
        <div class="row">
            <div class="loginbox mainbox col-sm-offset-2 col-md-offset-3 col-md-6 col-sm-8">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <div class="panel-title">Вход</div>
                    </div>
                    <div class="panel-body">
                        <form method="post" class="form-horizontal" role="form">

                            <label for="sel1">Выберите отдел:</label>
                            <div class="input-group col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-flag"></i></span>
                                <select class="form-control dep-selector" id="sel1">
                                    @if (deps != null)
                                    {
                                        foreach (var dep in deps)
                                        {
                                            <option value="@dep.Id">@dep.Name</option>
                                        }
                                    }
                                </select>
                            </div>

                            <label for="sel2">Выберите сотрудника:</label>
                            <div class="input-group col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                                <select class="form-control employee-selector" id="sel2" name="employee-selector"></select>
                            </div>

                            <label for="pass">Введите пароль:</label>
                            <div class="input-group has-feedback">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                                <input type="password" id="pass" class="form-control password-input" name="password" placeholder="пароль">
                            </div>

                            <div class="input-group">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" name="remember" value="1" checked> Запомнить
                                    </label>
                                </div>
                            </div>

                            <div class="form-group container-login-btn">
                                <!-- Button -->
                                <div class="col-sm-12 controls">
                                    <button class="btn btn-success" name="login-btn" value="1">Войти</button>
                                </div>
                            </div>

                            <div class="alert alert-danger col-sm-12 hide"></div>

                            @if (successMessage != null)
                            {
                                <div class="alert alert-success col-sm-12">@successMessage</div>
                            }

                            @if (errorMessage != null)
                            {
                                <div class="alert alert-danger col-sm-12">@errorMessage</div>
                            }

                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- ErrorModal -->
        @RenderPage("~/Pages/_ErrorModalPartial.cshtml")
        <!--  -->
    </div>

    <script src="~/Scripts/jquery-2.2.2.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/ProjectScripts/signin.js"></script>
</body>
</html>
