@using TestSite.PL.WebPages.Models
@{
    if (!User.Identity.IsAuthenticated)
    {
        Response.StatusCode = 401;
        return;
    }

    const string adminRole = "admin";
    const string superAdminRole = "superadmin";
    const string inspectorRole = "inspector";

    var queries = new Dictionary<string, IDictionary<string, Func<HttpRequestBase, AjaxResponse>>>()
    {
        { adminRole,  AdminsAjaxPage.AdminsQueries },
        { superAdminRole, AdminsAjaxPage.SuperadminsQueries },
        { inspectorRole, AdminsAjaxPage.InspectorsQueries },
    };

    string usersRole = null;

    try
    {
        var userId = Convert.ToInt32(User.Identity.Name);
        usersRole = LogicProvider.EmployeeLogic.ListRolesForUserByUserId(userId).SingleOrDefault();
    }
    catch (Exception ex)
    {
        Response.Write(Json.Encode(new AjaxResponse(ex.Message)));
    }

    var queryName = Request["queryName"];

    if (IsAjax && queryName != null)
    {
        AjaxResponse result = new AjaxResponse(null, null);

        if (queries[usersRole].ContainsKey(queryName))
        {
            result = queries[usersRole][queryName].Invoke(Request);
        }
        else
        {
            Response.Write(Json.Encode(new AjaxResponse("Не достаточно прав")));
            return;
        }

        if (result != null)
        {
            Response.Write(Json.Encode(result));
        }
    }
}
