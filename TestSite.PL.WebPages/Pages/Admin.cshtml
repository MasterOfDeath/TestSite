@using TestSite.PL.WebPages.Models
@{
    Layout = "~/_Layout.cshtml";
    PageData["Title"] = "Администрирование";

    const string adminRole = "admin";

    string errorMessage = null;
    ICollection<TestSite.Entites.Test> tests = null;

    var log = TestSite.Logger.Logger.Log;

    if (!User.Identity.IsAuthenticated)
    {
        Response.StatusCode = 401;
        return;
    }

    if (!User.IsInRole(adminRole))
    {
        Response.StatusCode = 403;
        return;
    }

    if (!IsPost)
    {
        TestSite.Entites.Employee employee;
        var employeeId = Convert.ToInt32(User.Identity.Name);

        try
        {
            employee = LogicProvider.EmployeeLogic.GetEmployeeById(employeeId);
            tests = LogicProvider.TestLogic.ListTestsByDepId(employee.Dep_Id);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            log.Error("ListTestsByDepId", ex);
        }
    }
}

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="content content-admin container-fluid" data-user-id="@User.Identity.Name">
    <div class="row">
        <div class="alert alert-success col-md-8 hide" role="alert">
            <button type="button" class="close">
                <span aria-hidden="true">&times;</span>
            </button>
            <p></p>
        </div>
    </div>

    <ul class="nav nav-tabs">
        <li class="listTests active"><a data-toggle="tab" href="#testsTab">Тесты</a></li>
        <li class="editTest hide"><a data-toggle="tab" href="#editTestTab"><b>Редактирование</b></a></li>
        <li><a data-toggle="tab" href="#reportTab">Статистика</a></li>
    </ul>

    <div class="tab-content">
        <div id="testsTab" class="tab-pane fade in active tests-tab">
            <div class="btn-group">
                <button class="btn btn-primary addTestBtn">Создать тест</button>
            </div>
            <div class="table-responsive general-table">
                <table class="table table-hover tests-table">
                    <tbody>
                        @if (tests != null)
                        {
                            foreach (var test in tests)
                            {
                                <tr data-id="@test.Id"><td>@test.Name</td></tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div id="editTestTab" class="tab-pane fade in editTest-tab" data-test-id="-1" data-test-name="">

            <div class="btn-group">
                <button class="btn btn-primary addQuestionBtn">Добавить вопрос</button>
                <button class="btn btn-default testPreviewBtn">Просмотр теста</button>
                <button class="btn btn-default editTestBtn">Изменить название теста</button>
                <button class="btn btn-default removeTestBtn">Удалить тест</button>
            </div>

            <div class="table-responsive general-table">
                <table class="table table-hover questions-table">
                    <tbody>
                        <!-- for replace -->
                    </tbody>
                </table>
            </div>

        </div>

        <div id="reportTab" class="tab-pane fade in report-tab">
            <!-- Report tab -->
            @RenderPage("~/Pages/_AdminReportPartial.cshtml")
            <!--  -->
        </div>

        <!-- Modal for edit and create test -->
        @RenderPage("~/Pages/_NamePromptPartial.cshtml")
        <!--  -->
        <!-- Modal for preview test -->
        @RenderPage("~/Pages/_AdminTestPreviewPartial.cshtml")
        <!--  -->
        <!-- Modal for edit and create question -->
        @RenderPage("~/Pages/_QuestionPromptPartial.cshtml")
        <!--  -->
        <!-- Modal for delete -->
        @RenderPage("~/Pages/_RemovePromptPartial.cshtml")
        <!--  -->

    </div> <!-- tab-content / end -->
    <!-- ErrorModal -->
    @RenderPage("~/Pages/_ErrorModalPartial.cshtml")
    <!--  -->
</div> <!-- container / end -->


@section header {
    <link rel="icon" type="image/png" href="~/images/icons/adminka.png" />
    <link href="~/Content/bootstrap-datepicker3.min.css" rel="stylesheet" />
    <link href="~/Content/ProjectStyles/admin.css" rel="stylesheet" />
    <link href="~/Content/ProjectStyles/admin-report.css" rel="stylesheet" />
    <link href="~/Content/ProjectStyles/generals/tables.css" rel="stylesheet" />
    <link href="~/Content/ProjectStyles/generals/schema.css" rel="stylesheet" />
    <link href="~/Content/ProjectStyles/generals/testTabs.css" rel="stylesheet" />
}

@section scripts {
    <script src="~/Scripts/jquery.panzoom.min.js"></script>
    <script src="~/Scripts/jquery.imagefit-0.2.js"></script>
    <script src="~/Scripts/jquery.table2excel.min.js"></script>
    <script src="~/Scripts/bootstrap-datepicker.min.js"></script>
    <script src="~/Scripts/locales/bootstrap-datepicker.ru.min.js"></script>
    <script src="~/Scripts/moment.min.js"></script>
    <script src="~/Scripts/ProjectScripts/admin.js"></script>
    <script src="~/Scripts/ProjectScripts/admin-test-preview.js"></script>
    <script src="~/Scripts/ProjectScripts/admin-report.js"></script>
}